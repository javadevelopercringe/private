-- knzxCMD Loader (KEY system + MockAPI + loadstring, без PATCH и вебхука)

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local HttpGet = game.HttpGet

-- ===== НАСТРОЙКИ =====
local MAIN_SCRIPT_URL = "https://raw.githubusercontent.com/javadevelopercringe/private/refs/heads/main/chatgpt"
local MOCKAPI_BASE = "https://69587d7a6c3282d9f1d523aa.mockapi.io/bd"

-- ===== УТИЛИТЫ HTTP =====
local function safeHttpGet(url)
    local ok, result = pcall(function()
        return HttpGet(game, url)
    end)
    if not ok then
        warn("[knzxCMD Loader] HttpGet error: "..tostring(result))
        return nil, result
    end
    return result
end

local function loadMainScript()
    local code, err = safeHttpGet(MAIN_SCRIPT_URL)
    if not code then
        return false, "Не удалось загрузить основной скрипт: "..tostring(err)
    end

    local fn, loadErr = loadstring(code)
    if not fn then
        return false, "Ошибка в loadstring: "..tostring(loadErr)
    end

    local ok, runErr = pcall(fn)
    if not ok then
        return false, "Ошибка при выполнении скрипта: "..tostring(runErr)
    end

    return true
end

-- ===== ПРОВЕРКА КЛЮЧА ЧЕРЕЗ MOCKAPI (только чтение) =====
local function checkKey(key)
    local url = MOCKAPI_BASE .. "?key=" .. HttpService:UrlEncode(key)
    local body, err = safeHttpGet(url)
    if not body then
        return false, "Ошибка запроса к БД: " .. tostring(err)
    end

    local ok, data = pcall(function()
        return HttpService:JSONDecode(body)
    end)
    if not ok then
        return false, "Некорректный ответ от БД."
    end

    if type(data) ~= "table" or #data == 0 then
        return false, "Ключ не найден."
    end

    local rec = data[1]
    local days = tonumber(rec.days) or 0
    local used = rec.used == true
    local owner = tostring(rec.ownerUserId or rec.owner or "")
    local created_at = tostring(rec.created_at or "")

    -- проверка срока
    local isExpired = false
    if created_at ~= "" and days > 0 then
        local createdUnix
        local ok2, res = pcall(function()
            local year, mon, day, hour, min, sec =
                created_at:match("^(%d+)%-(%d+)%-(%d+)T(%d+):(%d+):(%d+)")
            if year then
                return os.time({
                    year = tonumber(year),
                    month = tonumber(mon),
                    day = tonumber(day),
                    hour = tonumber(hour),
                    min = tonumber(min),
                    sec = tonumber(sec)
                })
            end
            return nil
        end)
        if ok2 then
            createdUnix = res
        end
        if createdUnix then
            local now = os.time()
            local diffDays = (now - createdUnix) / (60*60*24)
            if diffDays > days then
                isExpired = true
            end
        end
    end

    if isExpired then
        return false, "Срок действия ключа истёк."
    end

    -- простая защита: если used == true и owner не пустой, считаем что уже активирован
    if used and owner ~= "" then
        return false, "Ключ уже активирован."
    end

    -- НИКАКИХ PATCH/POST, только успешная проверка
    return true
end

-- ===== UI KEY LOADER =====
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "knzxCMD_Loader"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui

local Main = Instance.new("Frame")
Main.Name = "KeyMain"
Main.Size = UDim2.new(0, 360, 0, 180)
Main.Position = UDim2.new(0.5, -180, 0.5, -90)
Main.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
Main.BorderSizePixel = 0
Main.Active = true
Main.Draggable = true
Main.Parent = ScreenGui

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 8)
MainCorner.Parent = Main

local TopBar = Instance.new("Frame")
TopBar.Size = UDim2.new(1, 0, 0, 26)
TopBar.BackgroundColor3 = Color3.fromRGB(28, 28, 34)
TopBar.BorderSizePixel = 0
TopBar.Parent = Main
local TopBarCorner = Instance.new("UICorner")
TopBarCorner.CornerRadius = UDim.new(0, 8)
TopBarCorner.Parent = TopBar

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -40, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.Font = Enum.Font.GothamBold
Title.TextSize = 16
Title.TextColor3 = Color3.fromRGB(235, 235, 240)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Text = "knzxCMD Key Loader"
Title.Parent = TopBar

local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 24, 0, 18)
CloseButton.Position = UDim2.new(1, -28, 0.5, -9)
CloseButton.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
CloseButton.BorderSizePixel = 0
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 14
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(230, 230, 240)
CloseButton.Parent = TopBar
local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 4)
CloseCorner.Parent = CloseButton

local Content = Instance.new("Frame")
Content.Size = UDim2.new(1, -16, 1, -38)
Content.Position = UDim2.new(0, 8, 0, 30)
Content.BackgroundColor3 = Color3.fromRGB(22, 22, 28)
Content.BorderSizePixel = 0
Content.Parent = Main
local ContentCorner = Instance.new("UICorner")
ContentCorner.CornerRadius = UDim.new(0, 6)
ContentCorner.Parent = Content

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, -20, 0, 24)
TitleLabel.Position = UDim2.new(0, 10, 0, 8)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextSize = 18
TitleLabel.TextColor3 = Color3.fromRGB(220, 220, 235)
TitleLabel.Text = "Key Auth"
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = Content

local InfoLabel = Instance.new("TextLabel")
InfoLabel.Size = UDim2.new(1, -20, 0, 32)
InfoLabel.Position = UDim2.new(0, 10, 0, 32)
InfoLabel.BackgroundTransparency = 1
InfoLabel.Font = Enum.Font.Gotham
InfoLabel.TextSize = 13
InfoLabel.TextColor3 = Color3.fromRGB(190, 190, 205)
InfoLabel.TextWrapped = true
InfoLabel.TextXAlignment = Enum.TextXAlignment.Left
InfoLabel.TextYAlignment = Enum.TextYAlignment.Top
InfoLabel.Text = "Введите ваш ключ для загрузки knzxCMD."
InfoLabel.Parent = Content

local KeyBox = Instance.new("TextBox")
KeyBox.Size = UDim2.new(1, -20, 0, 26)
KeyBox.Position = UDim2.new(0, 10, 0, 70)
KeyBox.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
KeyBox.BorderSizePixel = 0
KeyBox.Font = Enum.Font.Gotham
KeyBox.TextSize = 14
KeyBox.TextColor3 = Color3.fromRGB(235, 235, 240)
KeyBox.PlaceholderText = "Key (например: K2C8XH27X28)"
KeyBox.Text = ""
KeyBox.ClearTextOnFocus = false
KeyBox.Parent = Content
local KeyCorner = Instance.new("UICorner")
KeyCorner.CornerRadius = UDim.new(0, 6)
KeyCorner.Parent = KeyBox

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, -20, 0, 36)
StatusLabel.Position = UDim2.new(0, 10, 0, 102)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 13
StatusLabel.TextColor3 = Color3.fromRGB(200, 120, 120)
StatusLabel.TextWrapped = true
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
StatusLabel.Text = ""
StatusLabel.Parent = Content

local LoadButton = Instance.new("TextButton")
LoadButton.Size = UDim2.new(1, -20, 0, 26)
LoadButton.Position = UDim2.new(0, 10, 1, -34)
LoadButton.BackgroundColor3 = Color3.fromRGB(70, 120, 70)
LoadButton.BorderSizePixel = 0
LoadButton.Font = Enum.Font.GothamBold
LoadButton.TextSize = 14
LoadButton.TextColor3 = Color3.fromRGB(235, 235, 240)
LoadButton.Text = "Check Key & Load"
LoadButton.Parent = Content
local LoadButtonCorner = Instance.new("UICorner")
LoadButtonCorner.CornerRadius = UDim.new(0, 6)
LoadButtonCorner.Parent = LoadButton

local isLoading = false

local function tryLoad()
    if isLoading then return end

    local key = (KeyBox.Text or ""):gsub("%s+", "")
    if key == "" then
        StatusLabel.TextColor3 = Color3.fromRGB(200, 120, 120)
        StatusLabel.Text = "Введите ключ."
        return
    end

    isLoading = true
    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 220)
    StatusLabel.Text = "Проверка ключа..."

    local ok, msg = checkKey(key)
    if not ok then
        isLoading = false
        StatusLabel.TextColor3 = Color3.fromRGB(200, 120, 120)
        StatusLabel.Text = msg or "Ошибка проверки ключа."
        return
    end

    StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 220)
    StatusLabel.Text = "Ключ принят. Загрузка скрипта..."

    local ok2, err2 = loadMainScript()
    if not ok2 then
        isLoading = false
        StatusLabel.TextColor3 = Color3.fromRGB(200, 120, 120)
        StatusLabel.Text = tostring(err2)
        return
    end

    local tween = TweenService:Create(
        Main,
        TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In),
        {BackgroundTransparency = 1}
    )
    tween:Play()
    tween.Completed:Connect(function()
        ScreenGui:Destroy()
    end)
end

LoadButton.MouseButton1Click:Connect(tryLoad)

KeyBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        tryLoad()
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

StatusLabel.TextColor3 = Color3.fromRGB(200, 200, 220)
StatusLabel.Text = "Введи ключ сука пидар донт лох бтв"
